# Database record file for Keithley 2290 high voltage power supply
# ISIS, November 2022
# Author : P.J. L. Heesterman (Capgemini Engineering)

###################################################
# Get functions
###################################################

# Read the device ID (only displays 39 chars)
record(stringin, "$(P):IDN") {
  field(DESC, "SCPI identification string")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_IDN $(P)")
  field(PINI, "YES")
}

# Read the current output voltage
record(ai, "$(P):VOLTAGE" {
  field(DESC, "Actual output voltage")
  filed(EGU,  "V")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_V $(P)")
  field(SCAN, "5 second")
  field(PINI, "YES")
}

# Read the output voltage limit
record(ai, "$(P):VOLTAGE_LIMIT" {
  field(DESC, "Output voltage limit")
  filed(EGU,  "V")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_V_limit $(P)")
  field(PINI, "YES")
}

# Read the output current
record(ai, "$(P):CURRENT" {
  field(DESC, "Output current")
  field(EGU,  "uA")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_I $(P)")
  field(SCAN, "5 second")
  field(PINI, "YES")
}

# Read the output current limit
record(ai, "$(P):CURRENT_LIMIT" {
  field(DESC, "Output current limit")
  field(EGU,  "uA")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_I_limit $(P)")
  field(PINI, "YES")
}

# Read the output current trip
record(ai, "$(P):CURRENT_TRIP" {
  field(DESC, "Output current trip")
  field(EGU,  "uA")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_I_trip $(P)")
  field(PINI, "YES")
}

# Returns the value of manual trip reset, 0 means manual and 1 means automatic
record(bi, "$(P):TRIP_RESET_MODE" {
  field(DESC, "Trip Reset Mode")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_trip_reset_mode $(P)")
  field(ZNAM, "Manual")
  field(ONAM, "Automatic")
}

# Returns the error status
record(longin, "$(P):ERROR" {
  field(DESC, "Error status")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_error_status $(P)")
  field(HIHI, "1.0")
}

# Returns the status byte
# Bit 0 - Stable  - Indicates that the VSET or ILIM value is stable.
# Bit 1 - V trip  - Indicates that a voltage trip has occurred.
# Bit 2 - I trip  - Indicates that a current trip has occurred.
# Bit 3 - I lim   - Indicates that a current limit condition has occurred.
# Bit 4 - MAV     - Indicates message available in the GPIB output queue.
# Bit 5 - ESB     - Indicates that an unmasked bit in the Standard Event Status Register has been set.
# Bit 6 - RQS/MSS - Request for Service/Master Summary Status.
# Bit 7 - HV on   - Indicates that the high voltage is on.
record(mbbidirect, "$(P):STATUS" {
  field(DESC, "Status byte")
  field(DTYP, "stream")
  field(INP,  "@devKeithley_2290.proto get_status_byte $(P)")
  field(SCAN, "5 second")
  field(PINI, "YES")
}

#######################################################
# Operations
#######################################################

# Reset to defaults
record(bo, "$(P):RST") {
  field(DESC, "SCPI reset")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto reset $(P)")
  field(HIGH, "0.0")
}

# Clear status
record(bo, "$(P):CLS") {
  field(DESC, "SCPI Clear status")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto clear_status")
  field(HIGH, "0.0")
}

# Clear trip
record(bo, "$(P):CLT") {
  field(DESC, "SCPI Clear trip")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto clear_trip")
  field(HIGH, "0.0")
}

#######################################################
# Set functions
#######################################################

# Set the requested output voltage
record(ao, "$(P):VOLTAGE:SP" {
  field(DESC, "Requested output voltage")
  filed(EGU,  "V")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto set_V $(P)")
}

# Set the output voltage limit
record(ao, "$(P):VOLTAGE_LIMIT:SP" {
  field(DESC, "Output voltage limit")
  filed(EGU,  "V")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto set_V_limit $(P)")
}

# Set the output current limit
record(ao, "$(P):CURRENT_LIMIT:SP" {
  field(DESC, "Output current limit")
  field(EGU,  "uA")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto set_I_limit $(P)")
}

# Set the output current trip
record(ao, "$(P):CURRENT_TRIP:SP" {
  field(DESC, "Output current trip")
  field(EGU,  "uA")
  field(DTYP, "stream")
  field(OUT,  "@devKeithley_2290.proto set_I_trip $(P)")
}

# Set the HV ON or OFF
record(bo, "$(P):HV_ON" {
  field(DESC, "HV ON or OFF")
  field(DTYP, "stream")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
  field(OUT,  "@devKeithley_2290.proto set_HV_ON $(P)")
}
